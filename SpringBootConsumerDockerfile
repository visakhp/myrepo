# Use latest ubuntu image as the base
FROM ubuntu:17.10

RUN useradd -m visakh ; echo visakh: | chpasswd ; usermod -a -G root visakh

ENV TOPDIR /springbootconsumer
ENV JBOSS_DIR $TOPDIR/jboss-eap-7.1

COPY jdk*.gz /tmp
COPY jboss*.zip /tmp

RUN mkdir /usr/lib/jvm
RUN mkdir $TOPDIR
RUN mkdir $TOPDIR/log

WORKDIR /tmp
RUN tar -zxf /tmp/jdk*.gz -C /usr/lib/jvm
RUN chmod -R 777 /usr/lib/jvm
RUN chown -R visakh:root /usr/lib/jvm
COPY springboot_consumer_environment.properties $TOPDIR

RUN update-alternatives --install /usr/bin/java java /usr/lib/jvm/jdk*/bin/java 100
RUN update-alternatives --install /usr/bin/javac javac /usr/lib/jvm/jdk*/bin/javac 100

RUN chmod 777 /usr/bin/java
RUN chmod 777 /usr/bin/javac

RUN apt-get update && \
      apt-get -y install unzip zip vim

RUN apt-get update && apt-get install -y iputils-ping

# Ensure signals are forwarded to the JVM process correctly for graceful shutdown
ENV LAUNCH_JBOSS_IN_BACKGROUND=true

RUN unzip -q /tmp/jboss*.zip -d $TOPDIR
RUN chmod -R 777 $TOPDIR
RUN chown -R visakh:root $TOPDIR
COPY springboot-consumer-service.war "$JBOSS_DIR/standalone/deployments"

WORKDIR $TOPDIR
#RUN cp $TOPDIR/springbootmongointegration.war "$JBOSS_DIR/standalone/deployments"

#RUN chown -R visakh:root $JBOSS_DIR
#RUN chmod -R 777 $JBOSS_DIR
ENV JAVA_HOME="/usr/lib/jvm/jdk1.8.0_152"

# RUN ls -al $JBOSS_DIR
# RUN ls -al $JBOSS_DIR/bin
# RUN java -version

RUN rm -f /tmp/jdk*.gz
RUN rm -f /tmp/jboss*.zip

ENV JAVA_OPTS="-Xms1024m -Xmx1024m -XX:MaxPermSize=256m -XX:+UseConcMarkSweepGC -XX:+CMSPermGenSweepingEnabled \
-XX:+CMSClassUnloadingEnabled -Djava.net.preferIPv4Stack=true -Ddeployment-logging-config=false -Djboss.server.log.dir=/springbootconsumer/log \
-Dspring.config.location=classpath:/org/spring/boot/consumer/service/springboot_application.properties,\
file:/springbootconsumer/springboot_consumer_environment.properties -Deureka.host=${eureka_host}"

# Expose the ports we're interested in
EXPOSE 8080

# Set the default command to run on boot
# This will boot JBoss EAP in the standalone mode and bind to all interface
CMD $JBOSS_DIR/bin/standalone.sh -b 0.0.0.0

